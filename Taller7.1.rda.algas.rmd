---
title: "Taller 7.1 Anális de Redundancia - RDAS"
author: "Javier Rodríguez Barrios"
date: 'Actualizado: `r Sys.Date()`'
output:
  html_document: 
    toc: yes
    toc_depth: 4
  pdf_document: 
    toc: yes
  html_notebook: 
    toc: yes
    toc_depth: 4
---

<b style='color:#1f78b4;'>

# Exploración gráfica multivariada - base *Insectos*

</b>


<b style='color:#1f78b4;'>

**Objetivo de la actividad:**

</b>

La siguiente base de datos es tomada del trabajo de (Osorio, 2021), relacionado a un estudio sobre la composición de microalgas de la ciénaga Sevillano en el complejo lagunar de la Ciénaga Grande de Santa Marta (Colombia). La información contiene a 21 géneros de microalgas (matriz Y) y 10 variables ambientales (matriz X) medidas en 24 observaciones (localidades y campañas de muestreo). El propósito del ejercicio consiste en determinar la relación entre la composición de las microalgas y las variables fisicoquímicas de su ambiente, aplicando un análisis de redundancia (RDA) y un Análisis de Correspondencia Canónica (ACC), para finalmente comparar la aplicación de cada técnica. Se utilizará el siguiente archivo: **Microalgas.csv**

Ejercicio tomado de: Rodríguez-Barrios (2023) [Enlace del libro](https://www.editdiazdesantos.com/libros/9788490524817/Rodr%C3%ADguez-Barrios-An%C3%A1lisis-de-datos-ecol%C3%B3gicos-y-ambientales-aplicaciones-con-el-programa-R.html?isbn=978849052481)

[Enlace de los archivos del libro](https://www.editdiazdesantos.com/libros/lanza_anejo.php?isbn=9788490524817&formato=.zip)


<b style='color:#1f78b4;'>

## Procedimiento de la exploración

</b>

- Cargar librerías requeridas

- Cargar la base `malezas.csv` 

- Realizar las opciones gráficas relacionadas a los objetivos.

- Realizar el nMDS con diferentes paquetes.




<b style='color:#1f78b4;'>

#### Cargar las librerías requeridas

</b>

```{r, warning=FALSE, message=FALSE}
# Librerías requeridas
library(ade4)
library(adegraphics)
library(adespatial)
library(cocorresp)
library(vegan)
library(MASS)
library(ellipse)
library(FactoMineR)
library(rrcov)
library(ggplot2)
library(reshape2)
library(ggrepel)
library(ggforce)

```


<b style='color:#1f78b4;'>

#### Funciones adiconales (Bordcard et al. 2018)

</b>

```{r, warning=FALSE, message=FALSE}
# Funciones a cargar
source("hcoplot.R")
source("triplot.rda.R")
source("plot.lda.R")
source("polyvars.R")
source("screestick.R")

```



<b style='color:#1f78b4;'>

#### Cargar o importar la base de datos

</b>

```{r, eval = FALSE}
# Base de datos
datos = read.csv2("Microalgas.csv",row.names=1)
```


<b style='color:#1f78b4;'>

#### Ajuste de las bases de datos biológica (tax.hel)

</b>

```{r, eval = FALSE}
# Ajuste de factores
datos$Tributario = as.factor (datos$Tributario) 	
str(datos)    # Nueva estructura de la base de datos

# Variables ambientales
amb=(datos[,c(2:11)]+1)
head(amb)

# Variables biol?gicas linealizadas - Taxones con Hellinger
tax.hel=decostand(datos[,c(12:32)],"hellinger")
head(tax.hel)
```


<b style='color:#1f78b4;'>

### 1) Ordenación de las localidades, los taxones y las variables ambientales.

</b>


```{r, eval = FALSE}
tax.rda<-rda(tax.hel ~.,amb)
tax.rda # Resultados resumidos

summary(tax.rda) # Resultados completos
```


<b style='color:#1f78b4;'>

### 2) Coeficientes de las variables regresoras (ambientales), en el modelo lineal.

</b>


```{r, eval = FALSE}
round(coef(tax.rda),4)
```

Distribución de los taxones (**Matriz Y**) = 0.031(**Amonio**) – 1.15(**Nitrito**) + … + 2.48(**Temp**)


<b style='color:#1f78b4;'>

### 3) R2 sin ajuste vs. R2 ajustado (Ezequiel 1930)

</b>


```{r, eval = FALSE}
# R^2 sin ajuste (inercia restringida)
(R2 <- RsquareAdj(tax.rda)$r.squared)

# R^2 ajustado
(R2adj <- RsquareAdj(tax.rda)$adj.r.squared)
```


<b style='color:#1f78b4;'>

### 4) Figura de Triplot

</b>


```{r, eval = FALSE}
dev.new(title = "RDA scaling 1 y 2",
        width = 16,height = 8,noRStudioGD = TRUE)
par(mfrow = c(1, 2))
# Scaling 1
plot(tax.rda,scaling=1, display = c("sp", "lc", "cn"), main="RDA - scaling 1")
# Scaling 2
plot(tax.rda, display = c("sp", "lc", "cn"), main="RDA - scaling 2")
```


<b style='color:#1f78b4;'>

### 5) Prueba global del RDA 

</b>


```{r, eval = FALSE}
# Prueba global del RDA (dos opciones)
# Ho= no hay relaci?n entre las variables X y las Y
anova(tax.rda, permutations = how(nperm = 1000))

# Prueba de los ejes can?nicos
anova(tax.rda, by = "axis", permutations = how(nperm = 1000))
```


<b style='color:#1f78b4;'>

### 6)  Factor de inflación de la varianza (VIF) del RDA

</b>


```{r, eval = FALSE}
# Factor de inflación
vif.cca(tax.rda)
```

Los resultados están por debajo de un VIF de 10, por lo que todas las variables son importantes para el análisis. 


<b style='color:#1f78b4;'>

### 7)  Criterios de selección de variables ambientales (X)

</b>

#### 7.1 Forward selection usando forward.sel()


```{r, eval = FALSE}
# Factor de inflación
forward.sel(tax.hel, amb, adjR2thresh = R2adj)
```


#### 7.2 Eliminación anticipada (Backward) usando "ordistep()" de vegan


```{r, eval = FALSE}
# Factor de inflación
forward.sel(tax.hel, amb, adjR2thresh = R2adj)
```

<b style='color:#1f78b4;'>

### 8. Eliminación anticipada (Backward) usando "ordistep()" de vegan

</b>

```{r, eval = FALSE}
step.backward <- ordistep(tax.rda,permutations = how(nperm = 499))
# Define a las mismas variables.
```

<b style='color:#1f78b4;'>

### 9. R2 ajustado

</b>

```{r, eval = FALSE}
RsquareAdj(step.backward)
# Se define un R^2: 0.2 (20% de relación)
```

<b style='color:#1f78b4;'>

### 10. RDA Parsimonioso (rda.par)

</b>

```{r, eval = FALSE}
# RDA resumido
(rda.pars <- rda(tax.hel ~ Temp + Vel_Corriente + Conductividad, data = amb))
```

<b style='color:#1f78b4;'>

### 11. Coeficientes del modelo lineal parsimonioso

</b>

```{r, eval = FALSE}
# RDA resumido
round(coef(rda.pars),4)
```

<b style='color:#1f78b4;'>

### 12. Dos Triplots del RDA parsimonioso (Scalng 1 y Scaing 2)

</b>

```{r, eval = FALSE}
dev.new(title = "RDA Parsimonioso scaling 1 y 2",
        width = 16,height = 8,noRStudioGD = TRUE)
par(mfrow = c(1, 2))

# Scaling 1
plot(rda.pars,scaling = 1,display = c("sp", "lc", "cn"),
     main = "Triplot RDA spe.esp ~ amb - scaling 1")
spe.sc1 <- scores(rda.pars, choices = 1:2, scaling = 1, display = "sp")
arrows(0, 0, spe.sc1[, 1] * 0.92,spe.sc1[, 2] * 0.92,
       length = 0, lty = 1, col = "red")
```




#----

<b style='color:#1f78b4;'>

### 13) RDA con paquete ggplot2

</b>

```{r, eval = FALSE}
# Insumos del RDA parsimonioso o que resume a las tres variables
(rda.pars <- rda(tax.hel ~ Temp + Vel_Corriente + Conductividad, data = amb))	# RDA resumido.
names(summary(rda.pars))	# Insumos del RDA parsimonioso

```

<p style='color:#1f78b4;'>

####  13.1 Coordenadas de los sitios y el factor "coord.sit"

</p>"

```{r, eval = FALSE}
# 1) Coordenadas de los sitios y el factor (coord.sit)
coord.sit <- as.data.frame(scores(rda.pars,
                                  choices = 1:2, display = "sites"))     # Coordenadas de los sitios
coord.sit$sitio <- rownames(coord.sit)      # Crear una columna con nombres de los sitios
coord.sit$grp <-  datos$Tributario               # Adicionar columna de grupos por Tributario
head(coord.sit)                             # vista resumida de las coordenadas de sitios
```


<p style='color:#1f78b4;'>

##### 13.2 Coordenadas de los taxones "coord.tax"

</p>


```{r, eval = FALSE}
# 2) Coordenadasde las especies (coord.tax) 
coord.tax <- as.data.frame(scores(rda.pars,
                                  choices = 1:2, display = "sp"))    # Dos primeros ejes
coord.tax$especies <- rownames(coord.tax)       # Insertar columna con nombres de las especies
head(coord.tax) 

```


<p style='color:#1f78b4;'>

##### 13.3 Coordenadas de las ambientales "coord.amb"

</p>


```{r, eval = FALSE}
# 2) Coordenadasde las especies (coord.tax) 
amb1 <- envfit(tax.rda, amb) # Se pueden seleccionar variables con, p.max = 0.05
coord.amb = as.data.frame(scores(amb1, "vectors"))
coord.amb$amb <- rownames(coord.amb)         # Insertar columna con nombres de las ambientales
coord.amb = coord.amb[c(6,8,10),] # La 3 variables seleccionadas
head(coord.amb) 

```





<p style='color:#1f78b4;'>

#### 13.4 Figura del RDA con vectores de especies

</p>"

```{r, eval = FALSE}
x11()
ggplot() +
  # Sitios
  geom_text_repel(data = coord.sit,aes(RDA1,RDA2,label=row.names(coord.sit)),
                  size=4)+   # Muestra el cuadro de la figura
  geom_point(data = coord.sit,aes(RDA1,RDA2,colour=grp),size=4)+
  scale_shape_manual(values = c(21:25))+
  # Taxones  
  geom_segment(data = coord.tax,aes(x = 0, y = 0, xend = RDA1, yend = RDA2), 
               arrow = arrow(angle=22.5,length = unit(0.25,"cm"),
                             type = "closed"),linetype=1, size=0.6,colour = "red")+
  geom_text_repel(data = coord.tax,aes(RDA1,RDA2,label=especies),colour = "red")+
  # Factor 
  geom_polygon(data=coord.sit,aes(x=RDA1,y=RDA2,fill=grp,group=grp),alpha=0.30) +
  
  geom_hline(yintercept=0,linetype=3,size=1) + 
  geom_vline(xintercept=0,linetype=3,size=1)+
  guides(shape=guide_legend(title=NULL,color="black"),
         fill=guide_legend(title=NULL))+
  theme_bw()+theme(panel.grid=element_blank())
```


<p style='color:#1f78b4;'>

#### 13.5 Figura con vectores de especies (sin flechas)

</p>"

```{r, eval = FALSE}
x11()
ggplot() +
  # Sitios
  geom_text_repel(data = coord.sit,aes(RDA1,RDA2,label=row.names(coord.sit)),
                  size=4)+   # Muestra el cuadro de la figura
  geom_point(data = coord.sit,aes(RDA1,RDA2,colour=grp),size=4)+
  scale_shape_manual(values = c(21:25))+
  # Taxones  *valores de cero para caracteres de las flechas (arrow)
  geom_segment(data = coord.tax,aes(x = 0, y = 0, xend = RDA1, yend = RDA2), 
               arrow = arrow(angle=0,length = unit(0,"cm"),
                             type = "closed"),linetype=0, size=0,colour = "red")+
  geom_text_repel(data = coord.tax,aes(RDA1,RDA2,label=especies),colour = "red")+
  # Factor 
  geom_polygon(data=coord.sit,aes(x=RDA1,y=RDA2,fill=grp,group=grp),alpha=0.30) +
  
  geom_hline(yintercept=0,linetype=3,size=1) + 
  geom_vline(xintercept=0,linetype=3,size=1)+
  guides(shape=guide_legend(title=NULL,color="black"),
         fill=guide_legend(title=NULL))+
  theme_bw()+theme(panel.grid=element_blank())

```


<p style='color:#1f78b4;'>

#### 13.7 Figura con vectores de especies y ambientales

</p>"

```{r, eval = FALSE}
x11()
ggplot() +
  # Sitios
  geom_text_repel(data = coord.sit,aes(RDA1,RDA2,label=row.names(coord.sit)),
                  size=4)+   # Muestra el cuadro de la figura
  geom_point(data = coord.sit,aes(RDA1,RDA2,colour=grp),size=4)+
  scale_shape_manual(values = c(21:25))+
  # especies  
  geom_segment(data = coord.tax,aes(x = 0, y = 0, xend = RDA1, yend = RDA2), 
               arrow = arrow(angle=0,length = unit(0,"cm"),
                             type = "closed"),linetype=0, size=0,colour = "red")+
  geom_text_repel(data = coord.tax,aes(RDA1,RDA2,label=especies),colour = "red")+
  # Ambiental  
  geom_segment(data = coord.amb,aes(x = 0, y = 0, xend = RDA1, yend = RDA2), 
               arrow = arrow(angle=22.5,length = unit(0.25,"cm"),
                             type = "closed"),linetype=1, size=0.6,colour = "blue")+
  geom_text_repel(data = coord.amb,aes(RDA1,RDA2,label=row.names(coord.amb)),colour = "#00abff")+
  # Factor 
  geom_mark_ellipse(data=coord.sit, aes(x=RDA1,y=RDA2,fill=grp,group=grp),alpha=0.30)  +
  
  geom_hline(yintercept=0,linetype=3,size=1) + 
  geom_vline(xintercept=0,linetype=3,size=1)+
  guides(shape=guide_legend(title=NULL,color="black"),
         fill=guide_legend(title=NULL))+
  theme_bw()+theme(panel.grid=element_blank())

```







<b style='color:#1f78b4;'>

## **Taller de entrenamiento**

</b>

**Objetivo:** Poner en práctica los conceptos vistos en este taller, realizando las siguientes opciones realizando un NMDS con las variables biológicas (taxones). Enviar los resultados al *Teams* del profesor.

